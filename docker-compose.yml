version: "3.8"

services:
  app:
    build:
      context: .
      target: development
    environment:
      DATABASE_HOST: ${DOCKER_COMPOSE_APP_DATABASE_HOST:-postgres}
      DATABASE_NAME: ${DOCKER_COMPOSE_APP_DATABASE_NAME:-${DOCKER_COMPOSE_POSTGRES_DB:-mindwendel-dev}}
      DATABASE_PORT: ${DOCKER_COMPOSE_APP_DATABASE_PORT:-${DOCKER_COMPOSE_POSTGRES_PORT:-5432}}
      DATABASE_SSL: ${DOCKER_COMPOSE_APP_DATABASE_SSL:-false}
      DATABASE_USER_PASSWORD: ${DOCKER_COMPOSE_APP_DATABASE_USER_PASSWORD:-${DOCKER_COMPOSE_POSTGRES_PASSWORD:-mindwendel-user-password}}
      DATABASE_USER: ${DOCKER_COMPOSE_APP_DATABASE_USER:-${DOCKER_COMPOSE_POSTGRES_USER:-mindwendel-user}}
      MW_DEFAULT_LOCALE: ${DOCKER_COMPOSE_APP_MW_DEFAULT_LOCALE:-en}
      MW_FEATURE_BRAINSTORMING_REMOVAL_AFTER_DAYS: ${DOCKER_COMPOSE_APP_MW_FEATURE_BRAINSTORMING_REMOVAL_AFTER_DAYS:-30}
      MW_FEATURE_BRAINSTORMING_TEASER: ${DOCKER_COMPOSE_APP_MW_FEATURE_BRAINSTORMING_TEASER:-true}
      PORT: 80
      SECRET_KEY_BASE: ${DOCKER_COMPOSE_APP_SECRET_KEY_BASE}
      TEST_DATABASE_HOST: ${DOCKER_COMPOSE_APP_TEST_DATABASE_HOST:-postgres}
      TEST_DATABASE_NAME: ${DOCKER_COMPOSE_APP_TEST_DATABASE_NAME:-${DOCKER_COMPOSE_POSTGRES_DB:-mindwendel-test}}
      TEST_DATABASE_USER_PASSWORD: ${DOCKER_COMPOSE_APP_TEST_DATABASE_USER_PASSWORD:-${DOCKER_COMPOSE_POSTGRES_PASSWORD:-mindwendel-user-password}}
      TEST_DATABASE_USER: ${DOCKER_COMPOSE_APP_TEST_DATABASE_USER:-${DOCKER_COMPOSE_POSTGRES_USER:-mindwendel-user}}
      URL_HOST: localhost
    ports:
      - "80:80"
    depends_on:
      - postgres
    # Mount the lib and test folder to increase development speed (do not use for prod setups!)
    volumes:
      - ./lib:/app/lib
      - ./test:/app/test
      - /app/deps/
      - /app/assets/node_modules
      - /app/priv/static

  postgres:
    image: postgres:12-alpine
    environment:
      PGDATA: /var/lib/postgresql/data/pgdata
      # IMPORTANT: Do not use these credentials in production. Please use other credentials when deploying this in production
      POSTGRES_DB: ${DOCKER_COMPOSE_POSTGRES_DB:-mindwendel-dev}
      POSTGRES_USER: ${DOCKER_COMPOSE_POSTGRES_USER:-mindwendel-user}
      POSTGRES_PASSWORD: ${DOCKER_COMPOSE_POSTGRES_PASSWORD:-mindwendel-user-password}
      POSTGRES_PORT: ${DOCKER_COMPOSE_POSTGRES_PORT:-5432}
    volumes:
      - postgres_data:/var/lib/postgresql/data

volumes:
  postgres_data:
